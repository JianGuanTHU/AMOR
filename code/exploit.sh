export CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7
export CUDA_LAUNCH_BLOCKING=1
MODEL_SIZE=7b
TOTAL_BATCH_SIZE=32
NUM_GPUS=8
BATCH_SIZE_PER_GPU=4
model_name=../output/warmup_model
GRADIENT_ACC_STEPS=$(($TOTAL_BATCH_SIZE/$NUM_GPUS/$BATCH_SIZE_PER_GPU))
echo $GRADIENT_ACC_STEPS
OUTPUT_DIR=../output/adaptation_model
accelerate launch --num_processes $NUM_GPUS --config_file=./accelerate_configs/deepspeed_zero3.yaml ./kto.py \
    --model_name_or_path=$model_name \
    --per_device_train_batch_size $BATCH_SIZE_PER_GPU \
    --num_train_epochs 2 \
    --learning_rate 5e-6 \
    --lr_scheduler_type=cosine \
    --gradient_accumulation_steps $GRADIENT_ACC_STEPS \
    --logging_steps 10 \
    --eval_steps 500 \
    --output_dir=$OUTPUT_DIR \
    --warmup_ratio 0.03 \
    --report_to wandb \
    --bf16 \
    --logging_first_step